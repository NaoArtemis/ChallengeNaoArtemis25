<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ongoing Match</title>
    <link rel="website icon" type="png" href="{{ url_for('static', filename='img/logo_v1.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

    <!-- barra superiore-->
    <div class="top-bar">
        <div class="logo">
            <img src="{{ url_for('static', filename='img/logo_con_scritta.png') }}" alt="BetterNao Logo">
        </div>
        <div class="top-bar-buttons">
            <button id="home" class="btn btn-logout">Home</button>
            <button id="logout" class="btn btn-logout">Logout</button>
        </div>
    </div>

    <!-- main -->
    <div class="main-content">
        <h1 class = "main-text">Gestione Partita</h1>

        <!-- Messaggio di stato -->
        <div id="status-message" style="margin-top: 15px; font-weight: bold; color: #333;"></div>


        <div class = "dashboard">
            <div class = "joystick-panel">

                <!-- Video Voronoi -->        
                <div>
                    <h2 class = "text">Video Voronoi</h2>
                    <!-- Nuovo container per caricare video solo al click -->
                    <div id="voronoi-container"></div>
                    <button class="btn btn-joystick" onclick="caricaVoronoi()">Carica Video Voronoi</button>
                </div>
            </div>

            <!-- Heatmap giocatori -->
            <div class="joystick-panel">
                <h2 class="text">Carica Video da Analizzare</h2>
                <input type="file" id="videoFile" accept="video/*" style="margin-top: 10px;" />
                <button class="btn btn-joystick" onclick="uploadVideo()">Carica Video</button>
                <button class="btn btn-joystick" onclick="analyze()">Analyze</button>
                <div id="upload-status" style="margin-top: 15px; font-weight: bold;"></div>
            </div>
        </div>

        <div class = "dashboard">
            <div class = "joystick-panel">
                <h1 class="text">Gestione Partita</h1>
                <div style = "color: black;", id="timer">00:00</div>
                <div class="mb-4">
                    <button onclick="startTimer()" class="btn btn-volume">Start</button>
                    <button onclick="stopTimer()" class="btn btn-volume">Pausa</button>
                    <button onclick="resetGame()" class="btn btn-volume">Fine Partita</button>
                </div>
                <div class="flex justify-center items-center space-x-8 text-2xl">
                    <div>
                        <div style = "color: black;">audace</div>
                        <button onclick="incrementScore('audace')" class="bg-red-500 text-white px-4 py-2 rounded">+</button>
                    </div>
                    <div id="score" , style = "color: black;">0:0</div>
                    <div>
                        <div style = "color: black;">Ospite</div>
                        <button onclick="incrementScore('ospite')" class="bg-blue-500 text-white px-4 py-2 rounded">+</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.tailwindcss.com"></script> <!-- carico liberria tailwind-->
        <!-- Script -->
        <script>

            function analyze() {
                document.getElementById("status-message").innerText = "Analisi in corso...";

                fetch('/analyze')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("status-message").innerText = "Analisi completata!";
                })
                .catch(() => {
                    document.getElementById("status-message").innerText = "Errore durante l'analisi.";
                });
            }


            function uploadVideo() {
                const fileInput = document.getElementById('videoFile');
                const file = fileInput.files[0];
                if (!file) {
                    document.getElementById("upload-status").innerText = "Seleziona un file video prima di caricare.";
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);

                fetch('/upload_video', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("upload-status").innerText = data.message;
                })
                .catch(() => {
                    document.getElementById("upload-status").innerText = "Errore durante il caricamento.";
                });
            }

            function caricaVoronoi() {
                document.getElementById("voronoi-container").innerHTML =
                    '<video controls style="max-width: 80%; border: 2px solid #333;">' +
                    '<source src="/stream_voronoi" type="video/mp4">' +
                    'Il tuo browser non supporta il video.' +
                    '</video>';
            }


            // parte score e time
                
            async function updateStatus() {
                const res = await fetch('/api/get_status');
                const data = await res.json();
                document.getElementById('timer').innerText = data.time;
                document.getElementById('score').innerText = `${data.audace}:${data.ospite}`;
            }

            async function startTimer() {
                await fetch('/api/start_timer', { method: 'POST' });
            }

            async function stopTimer() {
                await fetch('/api/stop_timer', { method: 'POST' });
            }

            async function resetGame() {
                await fetch('/api/reset_game', { method: 'POST' });
            }

            async function incrementScore(team) {
                await fetch(`/api/increment_score/${team}`, { method: 'POST' });
            }

            if (window.location.pathname === "/partita"){
            setInterval(updateStatus, 1000);
            }

        </script>

    </div>

    <!--  JS -->
    <script src="{{ url_for('static', filename='script/script.js') }}"></script>

</body>
</html>
